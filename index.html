<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNOFFICIAL SUWINGS SYSTEM</title>
    <script>
      // xml을 json으로 변환해주는 xmlToJson함수 선언
      function xmlToJson(xml) {
        // Create the return object
        var obj = {}

        if (xml.nodeType == 1) {
          // element
          // do attributes
          if (xml.attributes.length > 0) {
            obj["@attributes"] = {}
            for (var j = 0; j < xml.attributes.length; j++) {
              var attribute = xml.attributes.item(j)
              obj["@attributes"][attribute.nodeName] = attribute.nodeValue
            }
          }
        } else if (xml.nodeType == 3) {
          // text
          obj = xml.nodeValue
        }

        // do children
        // If all text nodes inside, get concatenated text from them.
        var textNodes = [].slice.call(xml.childNodes).filter(function (node) {
          return node.nodeType === 3
        })
        if (xml.hasChildNodes() && xml.childNodes.length === textNodes.length) {
          obj = [].slice.call(xml.childNodes).reduce(function (text, node) {
            return text + node.nodeValue
          }, "")
        } else if (xml.hasChildNodes()) {
          for (var i = 0; i < xml.childNodes.length; i++) {
            var item = xml.childNodes.item(i)
            var nodeName = item.nodeName
            if (typeof obj[nodeName] == "undefined") {
              obj[nodeName] = xmlToJson(item)
            } else {
              if (typeof obj[nodeName].push == "undefined") {
                var old = obj[nodeName]
                obj[nodeName] = []
                obj[nodeName].push(old)
              }
              obj[nodeName].push(xmlToJson(item))
            }
          }
        }
        return obj
      }
    </script>
    <script>
      function convertSemester(data) {
        if (data == "10") return "1학기 정규"
        else if (data == "15") return "1학기 계절"
        else if (data == "20") return "2학기 정규"
        else if (data == "25") return "2학기 계절"
      }
      function submit() {
        const id = document.getElementById("STUDENT_NUMBER").value
        document.getElementById("info").innerHTML = ""
        fetch("http://127.0.0.1/student?id=" + id, {
          method: "GET",
        })
          .then((data11) => data11.text())
          .then((data1) => {
            let xml1 = new DOMParser().parseFromString(data1, "text/xml")
            let convert = xmlToJson(xml1)["vector"]["data"]
            for (let c of convert) {
              const y = c["ROW"]["YY"]["@attributes"]["value"]
              const s = c["ROW"]["SHTM_CD"]["@attributes"]["value"]
              if (s == 15 || s == 25) continue
              fetch("http://127.0.0.1/rank?id=" + id + "&y=" + y + "&s=" + s, {
                method: "GET",
              })
                .then((data22) => data22.text())
                .then((data2) => {
                  let body = ""
                  let xml2 = new DOMParser().parseFromString(data2, "text/xml")
                  let cc = xmlToJson(xml2)["vector"]["data"]
                  body += "<div>"
                  body += y + "-" + convertSemester(s)
                  body += " : " + c["ROW"]["AVRP"]["@attributes"]["value"]
                  body +=
                    " | 학과 " +
                    (cc == undefined ? "00" : cc["ROW"]["ORGN4_PRNS"]["@attributes"]["value"]) +
                    "명 중 <b>" +
                    c["ROW"]["SUST_RANK"]["@attributes"]["value"] +
                    "</b>등"
                  body +=
                    " | 전교 " +
                    (cc == undefined ? "00" : cc["ROW"]["ORGN2_PRNS"]["@attributes"]["value"]) +
                    "명 중 <b>" +
                    (cc == undefined ? "00" : cc["ROW"]["TESCH_RANK"]["@attributes"]["value"]) +
                    "</b>등"
                  // body +=
                  //   " : " +
                  //   c["ROW"]["SUST_RANK"]["@attributes"]["value"] +
                  //   " / " +
                  //   (cc == undefined ? "00" : cc["ROW"]["ORGN4_PRNS"]["@attributes"]["value"]);
                  body += "</div>"
                  document.getElementById("info").innerHTML += body
                })
            }
          })
          .catch(function (error) {
            console.log(error)
          })
      }
    </script>
  </head>
  <body>
    <h1>UNOFFICIAL SUWINGS SYSTEM</h1>
    <hr />
    <div>학번: <input type="text" id="STUDENT_NUMBER" /><button onclick="submit()">조회</button></div>
    <div id="info"></div>
  </body>
</html>
